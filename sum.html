<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Math Mastery</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; touch-action: manipulation; overflow: hidden; position: fixed; width: 100%; height: 100%; margin: 0; padding-top: 1rem; }
    .fredoka { font-family: 'Fredoka One', cursive; font-variant-numeric: tabular-nums; }
    .card { transform-style: preserve-3d; transition: transform 0.6s, opacity 0.3s ease; }
    .card.is-flipped { transform: rotateY(180deg); }
    .card-face { 
      backface-visibility: hidden; 
      -webkit-backface-visibility: hidden;
      transform: translate3d(0, 0, 0);
      -webkit-transform: translate3d(0, 0, 0);
    }
    .card-face-back { 
      transform: rotateY(180deg) translate3d(0, 0, 0);
      -webkit-transform: rotateY(180deg) translate3d(0, 0, 0);
    }
    /* rest of your styles unchanged */
    .problem-tag { font-family: 'Fredoka One', cursive; padding: 1px 8px; border-radius: 6px; font-size: 0.9rem; height: 1.8rem;
      min-width: 3.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.1); color: white; transition: background-color 0.3s ease, font-size 0.3s ease;
      display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    /* ... all other styles remain exactly the same ... */
  </style>
</head>
<body class="bg-blue-100 flex flex-col items-center justify-start p-1">
  <!-- HTML unchanged until script -->
  <script>
    /* ... all your variables and functions until checkAnswer and nextQuestion ... */

    async function checkAnswer(userAnswer, buttonEl=null) {
      if (isSoundOn) { await Tone.start(); }
      totalAttempts++;

      if (emojiPool.length === 0) {
        emojiPool = [...MASTER_EMOJI_LIST];
        shuffleArray(emojiPool);
      }
      const randomEmoji = emojiPool.pop();

      if (gameMode === 'keypad') keypadEl.querySelectorAll('button').forEach(btn => btn.disabled = true);
      else answerOptionsEl.querySelectorAll('button').forEach(btn => btn.disabled = true);

      const isCorrect = userAnswer === correctAnswer;
      const problemTag = document.getElementById(`tag-${activeProblemKey}`);
      if (problemTag) problemTag.classList.remove('is-current-question');

      if (isCorrect) {
        playCorrectSound();
        /* correct path unchanged */
      } else {
        playIncorrectSound();
        if (buttonEl) {
          buttonEl.classList.add('incorrect');
          answerOptionsEl.querySelectorAll('button').forEach(btn => {
            if (parseInt(btn.textContent) === correctAnswer) btn.classList.add('correct');
          });
        }
        wrongAttempts[activeProblemKey] = (wrongAttempts[activeProblemKey] || 0) + 1;
        if (!problemsGottenWrongInRound.some(p => p[0] === currentProblem[0] && p[1] === currentProblem[1])) problemsGottenWrongInRound.push(currentProblem);
        allTimeWrongProblems.add(activeProblemKey);
        problemsToDo = problemsToDo.filter(p => p !== currentProblem);
        renderWrongList();
        document.getElementById('result-display').innerHTML = `<p class="fredoka text-5xl">${activeProblemKey}=${correctAnswer}</p>`;
        cardEl.classList.add('is-flipped');
        updateCardHeight();
        setTimeout(nextQuestion, 2500);
      }
      updateProgressCount();
    }

    function nextQuestion() {
      if (cardEl.classList.contains('is-flipped')) {
        cardEl.classList.remove('is-flipped');
        setTimeout(() => {
          document.getElementById('result-display').innerHTML = '';
          currentInput = ''; answerDisplayEl.textContent = '';
          generateProblem();
          updateCardHeight();
        }, 300);
      } else {
        generateProblem();
      }
    }

    /* In the two problem-set loops (both add and sub blocks) change:

    for (let j = 1; j <= to; j++) {   // ← fixed: always use "to"

    /* In start-game sound step */
    const from = parseInt(fromTableInput.value || fromTableInput.placeholder);
    const to = parseInt(toTableInput.value || toTableInput.placeholder);

    initialProblemSet = [];
    const problemMap = new Set();

    if (gameOperation === 'add') {
        gameTitleEl.textContent = "Addition Mastery";
        for (let i = from; i <= to; i++) {
            for (let j = 1; j <= to; j++) {   // ← fixed
                const key = Math.min(i, j) + "+" + Math.max(i, j);
                if (!problemMap.has(key)) {
                    problemMap.add(key);
                    initialProblemSet.push([Math.min(i, j), Math.max(i, j)]);
                }
            }
        }
    } else { // subtract
        gameTitleEl.textContent = "Subtraction Mastery";
        for (let i = from; i <= to; i++) {
            for (let j = 1; j <= to; j++) {   // ← fixed
                const num1 = Math.max(i, j);
                const num2 = Math.min(i, j);
                const key = `${num1}-${num2}`;
                if (!problemMap.has(key)) {
                    problemMap.add(key);
                    initialProblemSet.push([num1, num2]);
                }
            }
        }
    }

    /* rest of script unchanged */

    window.onload = () => {
      createKeypad();
      createSetupKeypad();
      showSetupScreen();
    };
  </script>
</body>
</html>
